'use client';

import { useState, useEffect } from 'react';
import Lottie from 'lottie-react';
import { sendSecureProxyRequest } from '../utils/api';

interface MalzemeDetay {
  'ƒ∞≈üyeri No': number;
  'ƒ∞≈üyeri Adƒ±': string;
  'Ambar No': number;
  'Ambar Adƒ±': string;
  'Stok Miktarƒ±': number;
  'Aktif Satƒ±≈ü Fiyatƒ±': number;
  'Fiyat Kaynaƒüƒ±': string;
  'Son Fiyat Deƒüi≈üim Tarihi': string;
  'Devir Miktarƒ±': number;
  'Ambar Transfer Giri≈ü Miktarƒ±': number;
  'Son Alƒ±≈ü Tarihi': string;
  'Son Alƒ±≈ü Birim Fiyatƒ±': number;
  'Son Alƒ±≈ü Miktarƒ±': number;
  'Son Satƒ±≈ü Tarihi': string;
  'Son Satƒ±≈ü Birim Fiyatƒ±': number;
  'D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi': string;
  'D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±': number;
  'D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±': number;
  'Son Satƒ±≈ü Tarihi (Tarih Aralƒ±ƒüƒ±)': string;
  'D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±': number;
  'D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±': number;
}

interface MalzemeDetayModalProps {
  isOpen: boolean;
  onClose: () => void;
  malzemeKodu: string;
  malzemeAdi: string;
  itemRef: string;
  clientRef: string;
  startDate: string;
  endDate: string;
}

export default function MalzemeDetayModal({
  isOpen,
  onClose,
  malzemeKodu,
  malzemeAdi,
  itemRef,
  clientRef,
  startDate,
  endDate
}: MalzemeDetayModalProps) {
  const [data, setData] = useState<MalzemeDetay[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [animationData, setAnimationData] = useState<any>(null);
  const [spCreated, setSpCreated] = useState(false);

  // Animation data'yƒ± y√ºkle
  useEffect(() => {
    import('../../public/animations/loading.json').then((data) => {
      setAnimationData(data.default);
    }).catch((err) => {
      console.error("Animasyon dosyasƒ± y√ºklenemedi:", err);
    });
  }, []);

  // Cache'i temizleme fonksiyonu
  const clearCacheAndReload = () => {
    const spCacheKey = `sp_MalzemeDetayByItem_${localStorage.getItem('companyRef')}`;
    localStorage.removeItem(spCacheKey);
    console.log('üóëÔ∏è Cache temizlendi, yeni veri getiriliyor...');
    setSpCreated(false);
    checkAndCreateStoredProcedure();
  };

  // Modal a√ßƒ±ldƒ±ƒüƒ±nda veriyi getir
  useEffect(() => {
    if (isOpen && itemRef) {
      // Stored procedure kontrol√ºn√º localStorage'da cache'le
      const spCacheKey = `sp_MalzemeDetayByItem_${localStorage.getItem('companyRef')}`;
      const spExists = localStorage.getItem(spCacheKey) === 'true';
      
      if (spExists) {
        console.log('‚úÖ Stored procedure cache\'den mevcut, direkt veri getiriliyor...');
        setSpCreated(true);
        fetchMalzemeDetay();
      } else {
        console.log('üîç Stored procedure kontrol ediliyor...');
        checkAndCreateStoredProcedure();
      }
    } else if (!isOpen) {
      // Modal kapandƒ±ƒüƒ±nda state'leri temizle
      setData([]);
      setError(null);
      setLoading(false);
    }
  }, [isOpen, itemRef]);

  const checkAndCreateStoredProcedure = async () => {
    setLoading(true);
    setError(null);

    try {
      const companyRef = localStorage.getItem('companyRef') || 'btRapor_2024';

      // √ñnce stored procedure'ƒ±n mevcut olup olmadƒ±ƒüƒ±nƒ± kontrol et
      const checkSpQuery = `
        SELECT COUNT(*) as SPCount 
        FROM sys.objects 
        WHERE object_id = OBJECT_ID(N'dbo.sp_MalzemeDetayByItem') 
        AND type in (N'P', N'PC')
      `;

      console.log('üîç Stored procedure kontrol ediliyor...');
      const checkResponse = await sendSecureProxyRequest(
        companyRef,
        'first_db_key',
        { query: checkSpQuery },
        'https://api.btrapor.com/proxy',
        10000 // 10 saniye timeout
      );

      if (checkResponse.ok) {
        const checkResult = await checkResponse.json();
        const spExists = checkResult.data && checkResult.data.length > 0 && checkResult.data[0].SPCount > 0;
        
        if (spExists) {
          console.log('‚úÖ Stored procedure zaten mevcut, direkt veri getiriliyor...');
          setSpCreated(true);
          // Cache'i g√ºncelle
          const spCacheKey = `sp_MalzemeDetayByItem_${localStorage.getItem('companyRef')}`;
          localStorage.setItem(spCacheKey, 'true');
          await fetchMalzemeDetay();
        } else {
          console.log('üîß Stored procedure mevcut deƒüil, olu≈üturuluyor...');
          await createStoredProcedure();
        }
      } else {
        console.log('‚ö†Ô∏è Stored procedure kontrol√º ba≈üarƒ±sƒ±z, olu≈üturuluyor...');
        await createStoredProcedure();
      }
    } catch (err) {
      console.error('Stored procedure kontrol hatasƒ±:', err);
      setError(err instanceof Error ? err.message : 'Bilinmeyen hata');
      setLoading(false);
    }
  };

                   const createStoredProcedure = async () => {
      // Loading state zaten checkAndCreateStoredProcedure tarafƒ±ndan y√∂netiliyor

      try {
        const companyRef = localStorage.getItem('companyRef') || 'btRapor_2024';

                 // √ñnce IdList user-defined table type'ƒ±nƒ± olu≈ütur (eƒüer yoksa)
         try {
           const createIdListQuery = `
             IF NOT EXISTS (SELECT * FROM sys.types WHERE name = 'IdList' AND is_user_defined = 1)
             BEGIN
               CREATE TYPE dbo.IdList AS TABLE
               (
                 ID INT NOT NULL PRIMARY KEY
               );
             END
           `;

           console.log('üîß IdList Type olu≈üturuluyor (eƒüer yoksa):');
           console.log('='.repeat(80));
           console.log(createIdListQuery);
           console.log('='.repeat(80));

           const createIdListResponse = await sendSecureProxyRequest(
             companyRef,
             'first_db_key',
             { query: createIdListQuery },
             'https://api.btrapor.com/proxy',
             600000 // 10 dakika timeout
           );

           if (createIdListResponse.ok) {
             console.log('‚úÖ IdList Type ba≈üarƒ±lƒ±');
           } else {
             console.log('‚ö†Ô∏è IdList Type hatasƒ± (devam ediliyor):', createIdListResponse.status);
           }
         } catch (idListError) {
           console.log('‚ö†Ô∏è IdList Type hatasƒ± (devam ediliyor):', idListError);
         }

         // DROP PROCEDURE hatasƒ± olursa devam et (zaten mevcut olmayabilir)
         try {
           const dropSpQuery = `
             IF OBJECT_ID('dbo.sp_MalzemeDetayByItem','P') IS NOT NULL
               DROP PROCEDURE dbo.sp_MalzemeDetayByItem;
           `;

          console.log('üîß DROP PROCEDURE deneniyor (mevcut deƒüilse hata normal):');
          console.log('='.repeat(80));
          console.log(dropSpQuery);
          console.log('='.repeat(80));

          const dropResponse = await sendSecureProxyRequest(
            companyRef,
            'first_db_key',
            { query: dropSpQuery },
            'https://api.btrapor.com/proxy',
            600000 // 10 dakika timeout
          );

          if (dropResponse.ok) {
            const dropResult = await dropResponse.json();
            console.log('‚úÖ DROP PROCEDURE ba≈üarƒ±lƒ±:', dropResult);
          } else {
            console.log('‚ö†Ô∏è DROP PROCEDURE hatasƒ± (normal, zaten mevcut deƒüil):', dropResponse.status);
          }
        } catch (dropError) {
          console.log('‚ö†Ô∏è DROP PROCEDURE hatasƒ± (devam ediliyor):', dropError);
        }

        // ƒ∞kinci sorgu: CREATE PROCEDURE (Yeni Optimized Version)
        const createSpQuery = `


CREATE PROCEDURE dbo.sp_MalzemeDetayByItem2
    @Firm              INT,
    @Period            INT,
    @ItemRef           INT,
    @DateFrom          DATE,
    @DateTo            DATE,
    @WarehouseList     dbo.IdList READONLY,  -- NR listesi (bo≈ü=t√ºm√º)
    @HasMarketModule   BIT,                  -- 1: sadece LK; 0: sadece LG
    @GoDb              SYSNAME = NULL,       -- GO tablolarƒ± DB (√∂rn. GO3); NULL/'' = current DB
    @GoSchema          SYSNAME = N'dbo',     -- GO tablolarƒ± ≈üema
    @ClientRef         INT                   -- alƒ±≈ü tedarik√ßi filtresi
AS
BEGIN
    SET NOCOUNT ON;

    -- (ƒ∞steƒüe baƒülƒ±) SSMS‚â†Web plan farklarƒ±nƒ± azalt
    SET ARITHABORT ON;
    SET ANSI_WARNINGS ON;
    SET CONCAT_NULL_YIELDS_NULL ON;
    SET QUOTED_IDENTIFIER ON;
    SET ANSI_PADDING ON;
    SET NUMERIC_ROUNDABORT OFF;

    ------------------------------------------------------------
    -- 0) Firma/D√∂nem ve tablo adlarƒ±
    ------------------------------------------------------------
    DECLARE @F3 VARCHAR(3) = RIGHT('000' + CAST(@Firm AS VARCHAR(3)), 3);
    DECLARE @P2 VARCHAR(2) = RIGHT('00' + CAST(@Period AS VARCHAR(2)), 2);

    DECLARE @T_STLINE_NAME   NVARCHAR(300) = N'LG_' + @F3 + N'_' + @P2 + N'_STLINE';
    DECLARE @T_LKPLC_NAME    NVARCHAR(300) = N'LK_' + @F3 + N'_PRCLIST';
    DECLARE @T_LKDIV_NAME    NVARCHAR(300) = N'LK_' + @F3 + N'_CAPIDIVPARAMS';
    DECLARE @T_LGPLC_NAME    NVARCHAR(300) = N'LG_' + @F3 + N'_PRCLIST';
    DECLARE @T_STINVTOT_LV   NVARCHAR(300) = N'LV_' + @F3 + N'_' + @P2 + N'_STINVTOT';
    DECLARE @T_STINVTOT_TBL  NVARCHAR(300) = N'LG_' + @F3 + N'_' + @P2 + N'_STINVTOT';

    DECLARE @T_STLINE_FQN   NVARCHAR(400) = N'[dbo].' + QUOTENAME(@T_STLINE_NAME);
    DECLARE @T_LKPLC_FQN    NVARCHAR(400) = N'[dbo].' + QUOTENAME(@T_LKPLC_NAME);
    DECLARE @T_LGPLC_FQN    NVARCHAR(400) = N'[dbo].' + QUOTENAME(@T_LGPLC_NAME);
    DECLARE @T_LKDIV_FQN    NVARCHAR(400) = N'[dbo].' + QUOTENAME(@T_LKDIV_NAME);

    DECLARE @T_STINVTOT_FQN NVARCHAR(400);
    IF OBJECT_ID(N'dbo.' + QUOTENAME(@T_STINVTOT_LV)) IS NOT NULL
        SET @T_STINVTOT_FQN = N'[dbo].' + QUOTENAME(@T_STINVTOT_LV);
    ELSE
        SET @T_STINVTOT_FQN = N'[dbo].' + QUOTENAME(@T_STINVTOT_TBL);

    ------------------------------------------------------------
    -- 1) GO tablolarƒ± (ba≈üka DB‚Äôde olabilir) - fully qualified
    ------------------------------------------------------------
    DECLARE @DbPrefix NVARCHAR(260);
    DECLARE @SchPrefix NVARCHAR(130);
    DECLARE @WH_FQN NVARCHAR(512);
    DECLARE @DIV_FQN NVARCHAR(512);

    SET @DbPrefix  = CASE WHEN @GoDb IS NULL OR LTRIM(RTRIM(@GoDb)) = '' THEN N'' ELSE QUOTENAME(@GoDb) + N'.' END;
    SET @SchPrefix = QUOTENAME(@GoSchema) + N'.';
    SET @WH_FQN    = @DbPrefix + @SchPrefix + QUOTENAME(N'L_CAPIWHOUSE');
    SET @DIV_FQN   = @DbPrefix + @SchPrefix + QUOTENAME(N'L_CAPIDIV');

    ------------------------------------------------------------
    -- 2) Ambar kolon/ifadeleri
    ------------------------------------------------------------
    DECLARE @WhExpr_STLINE       NVARCHAR(100) = N'S.[SOURCEINDEX]';
    DECLARE @WhExpr_STLINE_Dest  NVARCHAR(100) = N'S.[DESTINDEX]';
    DECLARE @WhExpr_STINVTOT     NVARCHAR(120) = N'T.[INVENNO]';

    ------------------------------------------------------------
    -- 3) Fiyat kaynak bloklarƒ± (se√ßim: sadece LK veya sadece LG)
    ------------------------------------------------------------
    DECLARE @priceApply NVARCHAR(MAX);
    DECLARE @priceExpr  NVARCHAR(MAX);
    DECLARE @srcExpr    NVARCHAR(MAX);
    DECLARE @chgExpr    NVARCHAR(MAX);
    DECLARE @divJoin    NVARCHAR(MAX) = N'';

    IF @HasMarketModule = 1
    BEGIN
        -- Sadece LK; yoksa NULL (LG fallback YOK)
        IF OBJECT_ID(N'dbo.' + QUOTENAME(@T_LKPLC_NAME)) IS NOT NULL
            SET @priceApply = N'
        OUTER APPLY (
            SELECT TOP (1)
                   CAST(P.BUYPRICE AS DECIMAL(19,4)) AS BUYPRICE,
                   CAST(P.CHANGEDATE AS DATETIME)    AS CHANGEDATE
            FROM ' + @T_LKPLC_FQN + N' P WITH (NOLOCK)
            WHERE P.STREF = @ItemRef
              AND P.OFFICECODE = WD.DivNr
            ORDER BY P.LOGICALREF DESC
        ) AS LKP';
        ELSE
            SET @priceApply = N'
        OUTER APPLY (SELECT CAST(NULL AS DECIMAL(19,4)) AS BUYPRICE,
                            CAST(NULL AS DATETIME)      AS CHANGEDATE) AS LKP';

        SET @priceExpr = N'
            CAST(CASE WHEN LKP.BUYPRICE IS NOT NULL THEN LKP.BUYPRICE ELSE 0 END AS DECIMAL(19,4)) AS [Aktif Satƒ±≈ü Fiyatƒ±]';
        SET @srcExpr   = N'
            CASE WHEN LKP.BUYPRICE IS NOT NULL THEN ''Market(Kalem)'' ELSE ''tanƒ±mlƒ± fiyat yok'' END AS [Fiyat Kaynaƒüƒ±]';
        SET @chgExpr   = N'
            LKP.CHANGEDATE AS [Son Fiyat Deƒüi≈üim Tarihi]';

        -- Market parametre tablosu varsa join
        IF OBJECT_ID(N'dbo.' + QUOTENAME(@T_LKDIV_NAME)) IS NOT NULL
            SET @divJoin = N'
JOIN ' + @T_LKDIV_FQN + N' CD WITH (NOLOCK)
  ON CD._INDEX = 1
 AND CD._VALUE = CONVERT(VARCHAR(32), WD.DivNr)';
    END
    ELSE
    BEGIN
        -- Sadece LG
        IF OBJECT_ID(N'dbo.' + QUOTENAME(@T_LGPLC_NAME)) IS NOT NULL
            SET @priceApply = N'
        OUTER APPLY (
            SELECT TOP (1)
                   CAST(P.PRICE AS DECIMAL(19,4)) AS PRICE,
                   CAST(COALESCE(P.CAPIBLOCK_MODIFIEDDATE, P.CAPIBLOCK_CREADEDDATE) AS DATETIME) AS CHANGEDATE
            FROM ' + @T_LGPLC_FQN + N' P WITH (NOLOCK)
            WHERE P.CARDREF = @ItemRef
              AND P.ACTIVE  = 0
            ORDER BY P.LOGICALREF DESC
        ) AS LGO';
        ELSE
            SET @priceApply = N'
        OUTER APPLY (SELECT CAST(NULL AS DECIMAL(19,4)) AS PRICE,
                            CAST(NULL AS DATETIME)      AS CHANGEDATE) AS LGO';

        SET @priceExpr = N'
            CAST(CASE WHEN LGO.PRICE IS NOT NULL THEN LGO.PRICE ELSE 0 END AS DECIMAL(19,4)) AS [Aktif Satƒ±≈ü Fiyatƒ±]';
        SET @srcExpr   = N'
            CASE WHEN LGO.PRICE IS NOT NULL THEN ''Logo'' ELSE ''tanƒ±mlƒ± fiyat yok'' END AS [Fiyat Kaynaƒüƒ±]';
        SET @chgExpr   = N'
            LGO.CHANGEDATE AS [Son Fiyat Deƒüi≈üim Tarihi]';
    END

    ------------------------------------------------------------
    -- 4) WhFilter JOIN kararƒ±
    ------------------------------------------------------------
    DECLARE @WhJoin NVARCHAR(200);
    IF EXISTS (SELECT 1 FROM @WarehouseList)
        SET @WhJoin = N' INNER JOIN WhFilter F ON F.NR = W.NR ';
    ELSE
        SET @WhJoin = N'';

    ------------------------------------------------------------
    -- 5) Dinamik SQL
    ------------------------------------------------------------
    DECLARE @sql NVARCHAR(MAX);

    SET @sql = N'
DECLARE @DateToPlus1 DATE = DATEADD(DAY,1,@DateTo);

;WITH WhFilter AS (
    SELECT ID AS NR FROM @WarehouseList
),
Wh AS (
    SELECT W.NR, W.NAME, W.DIVISNR
    FROM ' + @WH_FQN + N' W WITH (NOLOCK)
    ' + @WhJoin + N'
    WHERE W.FIRMNR = @Firm
),
Divs AS (
    SELECT D.NR, D.NAME
    FROM ' + @DIV_FQN + N' D WITH (NOLOCK)
    WHERE D.FIRMNR = @Firm
),
WhDiv AS (
    SELECT W.NR AS WhNr, W.NAME AS WhName, D.NR AS DivNr, D.NAME AS DivName
    FROM Wh W
    LEFT JOIN Divs D ON D.NR = W.DIVISNR
),
OnHand AS (
    SELECT ' + @WhExpr_STINVTOT + N' AS WhNr,
           SUM(CAST(T.ONHAND AS NUMERIC(19,4))) AS OnHandQty
    FROM ' + @T_STINVTOT_FQN + N' T WITH (NOLOCK)
    WHERE T.STOCKREF = @ItemRef
    GROUP BY ' + @WhExpr_STINVTOT + N'
)
SELECT
    WD.DivNr                             AS [ƒ∞≈üyeri No],
    WD.DivName                           AS [ƒ∞≈üyeri Adƒ±],
    WD.WhNr                              AS [Ambar No],
    WD.WhName                            AS [Ambar Adƒ±],
    ISNULL(O.OnHandQty,0)                AS [Stok Miktarƒ±],
    ' + @priceExpr + N',
    ' + @srcExpr   + N',
    ' + @chgExpr   + N',
    Devir.DevirTotal                     AS [Devir Miktarƒ±],
    Transfer.TransferTotal               AS [Ambar Transfer Giri≈ü Miktarƒ±],
    LBL.DATE_                            AS [Son Alƒ±≈ü Tarihi],
    LBL.PRICE                            AS [Son Alƒ±≈ü Birim Fiyatƒ±],
    LBL.AMOUNT                           AS [Son Alƒ±≈ü Miktarƒ±],

    LSL.DATE_                            AS [Son Satƒ±≈ü Tarihi],
    LSL.PRICE                            AS [Son Satƒ±≈ü Birim Fiyatƒ±],
    
    RBL.DATE_                            AS [D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi],
    RBL.PRICE                            AS [D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±],
    RBT.BuyTotal                         AS [D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±],

    RSL.DATE_                            AS [Son Satƒ±≈ü Tarihi (Tarih Aralƒ±ƒüƒ±)],
    RSL.PRICE                            AS [D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±],
    RST.SaleTotal                        AS [D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±]
FROM WhDiv WD
LEFT JOIN OnHand O ON O.WhNr = WD.WhNr
' + @divJoin + N'

-- SON ALI≈û (global)
OUTER APPLY (
    SELECT TOP (1) S.DATE_, S.PRICE, S.AMOUNT, S.LINENET
    FROM ' + @T_STLINE_FQN + N' S WITH (NOLOCK)
    WHERE S.STOCKREF=@ItemRef AND S.CLIENTREF=@ClientRef AND S.LINETYPE=0 AND S.IOCODE=1 AND S.TRCODE=1
      AND ' + @WhExpr_STLINE + N' = WD.WhNr
    ORDER BY S.DATE_ DESC, S.LOGICALREF DESC
) AS LBL

-- SON SATI≈û (global)
OUTER APPLY (
    SELECT TOP (1) S.DATE_, S.PRICE, S.AMOUNT, S.LINENET
    FROM ' + @T_STLINE_FQN + N' S WITH (NOLOCK)
    WHERE S.STOCKREF=@ItemRef AND S.LINETYPE=0 AND S.IOCODE=4 AND S.TRCODE IN(7,8)
      AND ' + @WhExpr_STLINE + N' = WD.WhNr
    ORDER BY S.DATE_ DESC, S.LOGICALREF DESC
) AS LSL

-- SON ALI≈û (Aralƒ±k ƒ∞√ßi)
OUTER APPLY (
    SELECT TOP (1) S.DATE_, S.PRICE
    FROM ' + @T_STLINE_FQN + N' S WITH (NOLOCK)
    WHERE S.STOCKREF=@ItemRef 
      AND S.CLIENTREF=@ClientRef 
      AND S.LINETYPE=0 
      AND S.IOCODE=1 
      AND S.TRCODE=1
      AND ' + @WhExpr_STLINE + N' = WD.WhNr
      AND S.DATE_>=@DateFrom AND S.DATE_<@DateToPlus1
    ORDER BY S.DATE_ DESC, S.LOGICALREF DESC
) AS RBL

-- ALI≈û TOPLAMI (Aralƒ±k ƒ∞√ßi)
OUTER APPLY (
    SELECT SUM(S.AMOUNT) AS BuyTotal
    FROM ' + @T_STLINE_FQN + N' S WITH (NOLOCK)
    WHERE S.LINETYPE = 0
      AND S.CLIENTREF=@ClientRef
      AND S.IOCODE   = 1
      AND S.TRCODE   = 1
      AND S.STOCKREF = @ItemRef
      AND ' + @WhExpr_STLINE + N' = WD.WhNr
      AND S.DATE_   >= @DateFrom
      AND S.DATE_   <  @DateToPlus1
) AS RBT

-- DEVƒ∞R (Aralƒ±k ƒ∞√ßi)
OUTER APPLY (
    SELECT SUM(S.AMOUNT) AS DevirTotal
    FROM ' + @T_STLINE_FQN + N' S WITH (NOLOCK)
    WHERE S.LINETYPE = 0
      AND S.IOCODE   = 1
      AND S.TRCODE   = 14
      AND S.STOCKREF = @ItemRef
      AND ' + @WhExpr_STLINE + N' = WD.WhNr
      AND S.DATE_   >= @DateFrom
      AND S.DATE_   <  @DateToPlus1
) AS Devir

-- AMBAR TRANSFER Gƒ∞Rƒ∞≈û (Aralƒ±k ƒ∞√ßi)  >>> IOCODE=3 ve DESTINDEX ile
OUTER APPLY (
    SELECT SUM(S.AMOUNT) AS TransferTotal
    FROM ' + @T_STLINE_FQN + N' S WITH (NOLOCK)
    WHERE S.LINETYPE = 0
      AND S.IOCODE   = 3
      AND S.TRCODE   = 25
      AND S.STOCKREF = @ItemRef
      AND ' + @WhExpr_STLINE_Dest + N' = WD.WhNr
      AND S.DATE_   >= @DateFrom
      AND S.DATE_   <  @DateToPlus1
) AS Transfer

-- SON SATI≈û (Aralƒ±k ƒ∞√ßi)
OUTER APPLY (
    SELECT TOP (1) S.DATE_, S.PRICE
    FROM ' + @T_STLINE_FQN + N' S WITH (NOLOCK)
    WHERE S.STOCKREF=@ItemRef AND S.LINETYPE=0 AND S.IOCODE=4 AND S.TRCODE IN(7,8)
      AND ' + @WhExpr_STLINE + N' = WD.WhNr
      AND S.DATE_>=@DateFrom AND S.DATE_<@DateToPlus1
    ORDER BY S.DATE_ DESC, S.LOGICALREF DESC
) AS RSL

-- SATI≈û TOPLAMI (Aralƒ±k ƒ∞√ßi)
OUTER APPLY (
    SELECT SUM(S.AMOUNT) AS SaleTotal
    FROM ' + @T_STLINE_FQN + N' S WITH (NOLOCK)
    WHERE S.LINETYPE = 0
      AND S.IOCODE   = 4
      AND S.TRCODE   IN (7,8)
      AND S.STOCKREF = @ItemRef
      AND ' + @WhExpr_STLINE + N' = WD.WhNr
      AND S.DATE_   >= @DateFrom
      AND S.DATE_   <  @DateToPlus1
) AS RST

' + @priceApply + N'
ORDER BY WD.DivNr, WD.WhNr
OPTION (OPTIMIZE FOR UNKNOWN, RECOMPILE);';

    EXEC sp_executesql 
        @sql,
        N'@Firm INT, @ItemRef INT, @DateFrom DATE, @DateTo DATE, @WarehouseList dbo.IdList READONLY, @ClientRef INT',
        @Firm=@Firm, @ItemRef=@ItemRef, @DateFrom=@DateFrom, @DateTo=@DateTo, @WarehouseList=@WarehouseList, @ClientRef=@ClientRef;
END

        `;

                         console.log('üîß CREATE PROCEDURE ba≈ülƒ±yor:');
         console.log('='.repeat(80));
         console.log(createSpQuery);
         console.log('='.repeat(80));

        const createResponse = await sendSecureProxyRequest(
          companyRef,
          'first_db_key',
          { query: createSpQuery },
          'https://api.btrapor.com/proxy',
          600000 // 10 dakika timeout
        );

                 if (!createResponse.ok) {
           const errorText = await createResponse.text();
           console.error('‚ùå CREATE PROCEDURE hatasƒ±:', {
             status: createResponse.status,
             statusText: createResponse.statusText,
             error: errorText,
             responseHeaders: Object.fromEntries(createResponse.headers.entries())
           });
           
           // Hata detayƒ±nƒ± daha a√ßƒ±k g√∂ster
           let errorMessage = 'Stored procedure olu≈üturulamadƒ±';
           try {
             const errorJson = JSON.parse(errorText);
             if (errorJson.error) {
               errorMessage = `Stored procedure hatasƒ±: ${errorJson.error}`;
             } else if (errorJson.message) {
               errorMessage = `Stored procedure hatasƒ±: ${errorJson.message}`;
             }
           } catch (e) {
             if (errorText) {
               errorMessage = `Stored procedure hatasƒ±: ${errorText}`;
             }
           }
           
           throw new Error(errorMessage);
         }

        const createResult = await createResponse.json();
        console.log('‚úÖ CREATE PROCEDURE ba≈üarƒ±lƒ±:', createResult);
        
                 // √ú√ß√ºnc√º sorgu: Stored procedure'√º parametrelerle √ßaƒüƒ±r
         // Connection info'dan market_module kontrol et
         const testConnectionInfo = JSON.parse(localStorage.getItem('connectionInfo') || '{}');
         const testConnectionMarketModule = testConnectionInfo.market_module;
         const testHasMarketModule = testConnectionMarketModule === 1 ? 1 : 0;
         console.log('üîç createStoredProcedure - connectionInfo.market_module:', testConnectionMarketModule);
         console.log('üîç createStoredProcedure - connectionInfo.market_module tipi:', typeof testConnectionMarketModule);
         console.log('üîç createStoredProcedure - testHasMarketModule sonucu:', testHasMarketModule);
         
         // Connection bilgilerinden GO database bilgilerini al
         const connectionInfo = JSON.parse(localStorage.getItem('connectionInfo') || '{}');
         const testGoDb = connectionInfo.logo_kurulum_db_name || connectionInfo.logoKurulumDbName || 'GOWINGS';
         const testGoSchema = connectionInfo.go_schema || connectionInfo.goSchema || 'dbo';
         // Test i√ßin varsayƒ±lan bir cari ref kullan (ger√ßek kullanƒ±mda prop'tan gelecek)
         const testClientRef = '1';
         
         console.log('üîç Test GO Database bilgileri:', { testGoDb, testGoSchema, testClientRef });
         console.log('‚ö†Ô∏è Test ClientRef sabit deƒüer kullanƒ±yor, ger√ßek kullanƒ±mda prop\'tan gelecek');
         
         const executeSpQuery = `
           DECLARE @Wh dbo.IdList; 
           -- T√ºm ambarlar i√ßin bo≈ü bƒ±rakƒ±yoruz

           EXEC dbo.sp_MalzemeDetayByItem
             @Firm=9,
             @Period=1,
             @ItemRef=31742,
             @DateFrom='2025-01-01',
             @DateTo='2025-09-01',
             @WarehouseList=@Wh,
             @HasMarketModule=${testHasMarketModule},
             @GoDb='${testGoDb}',
             @GoSchema='${testGoSchema}',
             @ClientRef=${testClientRef};
         `;

                 console.log('üîß Test EXEC PROCEDURE ba≈ülƒ±yor:');
         console.log('='.repeat(80));
         console.log(executeSpQuery);
         console.log('='.repeat(80));

        const executeResponse = await sendSecureProxyRequest(
          companyRef,
          'first_db_key',
          { query: executeSpQuery },
          'https://api.btrapor.com/proxy',
          600000 // 10 dakika timeout
        );

                 if (!executeResponse.ok) {
           const errorText = await executeResponse.text();
           console.error('‚ùå EXEC PROCEDURE hatasƒ±:', {
             status: executeResponse.status,
             statusText: executeResponse.statusText,
             error: errorText,
             responseHeaders: Object.fromEntries(executeResponse.headers.entries())
           });
           
           // Hata detayƒ±nƒ± daha a√ßƒ±k g√∂ster
           let errorMessage = 'Stored procedure √ßalƒ±≈ütƒ±rƒ±lamadƒ±';
           try {
             const errorJson = JSON.parse(errorText);
             if (errorJson.error) {
               errorMessage = `EXEC hatasƒ±: ${errorJson.error}`;
             } else if (errorJson.message) {
               errorMessage = `EXEC hatasƒ±: ${errorJson.message}`;
             }
           } catch (e) {
             if (errorText) {
               errorMessage = `EXEC hatasƒ±: ${errorText}`;
             }
           }
           
           throw new Error(errorMessage);
         }

        const executeResult = await executeResponse.json();
        console.log('‚úÖ EXEC PROCEDURE ba≈üarƒ±lƒ±:', executeResult);
        
        setSpCreated(true);
        
        // Cache'i g√ºncelle
        const spCacheKey = `sp_MalzemeDetayByItem_${localStorage.getItem('companyRef')}`;
        localStorage.setItem(spCacheKey, 'true');
        
        // Stored procedure olu≈üturulduktan sonra detaylarƒ± getir
        await fetchMalzemeDetay();
     } catch (err) {
       console.error('Stored procedure olu≈üturma hatasƒ±:', err);
       setError(err instanceof Error ? err.message : 'Bilinmeyen hata');
       setLoading(false);
     }
   };

         const fetchMalzemeDetay = async () => {
     setLoading(true);
     setError(null);

     try {
       // Baƒülantƒ± bilgilerini al
       const connectionInfo = JSON.parse(localStorage.getItem('connectionInfo') || '{}');
       const firmaNo = connectionInfo.firmaNo || connectionInfo.first_firma_no || '9';
       const donemNo = connectionInfo.donemNo || connectionInfo.first_donem_no || '1';
       const companyRef = localStorage.getItem('companyRef') || 'btRapor_2024';
       
       // Market module parametresini connectionInfo'dan al (localStorage'da yok)
       const connectionMarketModule = connectionInfo.market_module;
       const hasMarketModule = connectionMarketModule === 1 ? 1 : 0;
      console.log('üîç fetchMalzemeDetay - connectionInfo.market_module:', connectionMarketModule);
      console.log('üîç fetchMalzemeDetay - connectionInfo.market_module tipi:', typeof connectionMarketModule);
      console.log('üîç fetchMalzemeDetay - hasMarketModule sonucu:', hasMarketModule);
       
       // GO veritabanƒ± bilgilerini connection bilgilerinden al
       const goDb = connectionInfo.logo_kurulum_db_name || connectionInfo.logoKurulumDbName || 'GO3';
       const goSchema = connectionInfo.go_schema || connectionInfo.goSchema || 'dbo';
       // ClientRef prop'tan gelen se√ßili cari ref'ini kullan
       const selectedClientRef = clientRef || '3';
       
       console.log('üîç GO Database bilgileri:', { goDb, goSchema, selectedClientRef });
       console.log('üîç Connection Info:', connectionInfo);
       console.log('üîç Se√ßili Cari Ref (prop):', clientRef);

       // SQL sorgusu - Stored procedure √ßaƒürƒ±sƒ± (ger√ßek parametrelerle)
       const sqlQuery = `
         DECLARE @Wh dbo.IdList; 
         -- T√ºm ambarlar i√ßin bo≈ü bƒ±rakƒ±yoruz

         EXEC dbo.sp_MalzemeDetayByItem
           @Firm=${firmaNo},
           @Period=${donemNo},
           @ItemRef=${itemRef},
           @DateFrom='${startDate}',
           @DateTo='${endDate}',
           @WarehouseList=@Wh,
           @HasMarketModule=${hasMarketModule},
           @GoDb='${goDb}',
           @GoSchema='${goSchema}',
           @ClientRef=${selectedClientRef};
       `;

      console.log('üîç Malzeme Detay SQL Sorgusu:');
      console.log('='.repeat(80));
      console.log(sqlQuery);
      console.log('='.repeat(80));
      console.log('üìä Sorgu Parametreleri:', { 
        firmaNo, 
        donemNo, 
        itemRef, 
        startDate, 
        endDate,
        hasMarketModule,
        goDb,
        goSchema,
        clientRef,
        companyRef 
      });
      console.log('üîó Proxy URL:', 'https://api.btrapor.com/proxy');
      console.log('‚è±Ô∏è Timeout:', '120000ms (2 dakika)');

      // Proxy √ºzerinden SQL sorgusunu √ßalƒ±≈ütƒ±r
      console.log('üöÄ SQL sorgusu g√∂nderiliyor...');
      const startTime = Date.now();
      const response = await sendSecureProxyRequest(
        companyRef,
        'first_db_key',
        { query: sqlQuery },
        'https://api.btrapor.com/proxy',
        120000 // 2 dakika timeout
      );
      const endTime = Date.now();
      console.log(`‚è±Ô∏è SQL sorgusu tamamlandƒ±: ${endTime - startTime}ms`);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Malzeme detay response hatasƒ±:', {
          status: response.status,
          statusText: response.statusText,
          error: errorText
        });
        throw new Error('Malzeme detaylarƒ± getirilemedi');
      }

      const result = await response.json();
      console.log('‚úÖ Malzeme detay response ba≈üarƒ±lƒ±:', {
        status: response.status,
        dataLength: result.results?.length || result.data?.length || 0,
        hasResults: !!result.results,
        hasData: !!result.data,
        fullResult: result // T√ºm response'u g√∂relim
      });
      
      // Farklƒ± data formatlarƒ±nƒ± kontrol et
      const data = result.results || result.data || result.recordset || result.rows || [];
      console.log('üìä Bulunan data:', data);
      setData(data);
    } catch (err) {
      console.error('Malzeme detay hatasƒ±:', err);
      setError(err instanceof Error ? err.message : 'Bilinmeyen hata');
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateStr: string) => {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('tr-TR');
  };

  const formatNumber = (num: number) => {
    if (num === null || num === undefined) return '-';
    return new Intl.NumberFormat('tr-TR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(num);
  };

  const formatCurrency = (num: number) => {
    if (num === null || num === undefined) return '-';
    return new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: 'TRY',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(num);
  };

  // Excel export fonksiyonu
  const exportToExcel = () => {
    if (data.length === 0) return;
    
    // Excel i√ßin veri hazƒ±rlama
    const excelData = data.map((item, index) => ({
      'Sƒ±ra': index + 1,
      '≈ûube No': item['ƒ∞≈üyeri No'],
      '≈ûube Adƒ±': item['ƒ∞≈üyeri Adƒ±'],
      'Ambar No': item['Ambar No'],
      'Ambar Adƒ±': item['Ambar Adƒ±'],
      'Fiyat Kaynaƒüƒ±': item['Fiyat Kaynaƒüƒ±'],
      'Aktif Satƒ±≈ü Fiyatƒ±': item['Aktif Satƒ±≈ü Fiyatƒ±'],
      'Son Fiyat Deƒüi≈üim Tarihi': item['Son Fiyat Deƒüi≈üim Tarihi'],
      'Stok Miktarƒ±': item['Stok Miktarƒ±'],
      'Devir Miktarƒ±': item['Devir Miktarƒ±'],
      'Ambar Giri≈ü Miktarƒ±': item['Ambar Transfer Giri≈ü Miktarƒ±'],
      'Son Alƒ±≈ü Tarihi': item['Son Alƒ±≈ü Tarihi'],
      'Son Alƒ±≈ü Birim Fiyatƒ±': item['Son Alƒ±≈ü Birim Fiyatƒ±'],
      'Son Alƒ±≈ü Miktarƒ±': item['Son Alƒ±≈ü Miktarƒ±'],
      'Son Satƒ±≈ü Tarihi': item['Son Satƒ±≈ü Tarihi'],
      'Son Satƒ±≈ü Birim Fiyatƒ±': item['Son Satƒ±≈ü Birim Fiyatƒ±'],
      'D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi': item['D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi'],
      'D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±': item['D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±'],
      'D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±': item['D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±'],
      'Son Satƒ±≈ü Tarihi (Tarih Aralƒ±ƒüƒ±)': item['Son Satƒ±≈ü Tarihi (Tarih Aralƒ±ƒüƒ±)'],
      'D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±': item['D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±'],
      'D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±': item['D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±']
    }));

    // CSV formatƒ±na √ßevirme
    const headers = Object.keys(excelData[0]);
    const csvContent = [
      headers.join(','),
      ...excelData.map(row => 
        headers.map(header => {
          const value = (row as any)[header];
          // Virg√ºl i√ßeren deƒüerleri tƒ±rnak i√ßine alma
          if (typeof value === 'string' && value.includes(',')) {
            return `"${value}"`;
          }
          return value;
        }).join(',')
      )
    ].join('\n');

    // Dosya indirme
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `malzeme_detay_${malzemeKodu}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // PDF export fonksiyonu
  const exportToPDF = () => {
    if (data.length === 0) return;
    
    const printContent = `
      <!DOCTYPE html>
      <html>
        <head>
          <title>Malzeme Detay Raporu - PDF</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 15px; font-size: 12px; }
            .header { margin-bottom: 25px; background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); }
            .header-top { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
            .logo { width: 100px; height: auto; flex-shrink: 0; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
            .header-content { flex: 1; }
            .header h1 { color: white; margin: 0 0 8px 0; font-size: 24px; text-align: left; font-weight: bold; letter-spacing: 0.5px; }
            .header p { margin: 3px 0; color: rgba(255,255,255,0.9); font-size: 14px; text-align: left; }
            
            /* ƒ∞statistik Kutularƒ± */
            .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
            .stat-box { border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; background-color: #f9fafb; }
            .stat-box.primary { border-color: #991b1b; background-color: #fef2f2; }
            .stat-box.success { border-color: #059669; background-color: #ecfdf5; }
            .stat-box.warning { border-color: #d97706; background-color: #fffbeb; }
            .stat-box.info { border-color: #0284c7; background-color: #f0f9ff; }
            .stat-title { font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
            .stat-value { font-size: 16px; font-weight: bold; color: #1f2937; }
            .stat-subtitle { font-size: 9px; color: #9ca3af; margin-top: 2px; }
            
            /* Malzeme Bilgileri */
            .malzeme-info { background-color: #f0f9ff; border: 1px solid #0ea5e9; padding: 15px; margin-bottom: 20px; border-radius: 6px; }
            .malzeme-info h3 { margin: 0 0 10px 0; color: #0c4a6e; font-size: 16px; }
            .malzeme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .malzeme-item { text-align: center; }
            .malzeme-value { font-size: 18px; font-weight: bold; color: #0c4a6e; }
            .malzeme-label { color: #0369a1; margin-top: 5px; font-size: 11px; }
            
            table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; table-layout: auto; }
            th, td { border: 1px solid #ddd; padding: 4px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            th { background-color: #991b1b; color: white; font-weight: bold; font-size: 11px; }
            tr:nth-child(even) { background-color: #f9f9f9; }
            .number { text-align: right; }
            .currency { font-weight: bold; }
            .center { text-align: center; }
            .section-title { color: #991b1b; margin: 20px 0 10px 0; font-size: 16px; border-bottom: 2px solid #991b1b; padding-bottom: 5px; }
            
            /* Kolon geni≈ülikleri - optimize edilmi≈ü */
            th:nth-child(1), td:nth-child(1) { min-width: 30px; max-width: 30px; } /* ≈ûube No */
            th:nth-child(2), td:nth-child(2) { min-width: 45px; max-width: 45px; } /* ≈ûube Adƒ± */
            th:nth-child(3), td:nth-child(3) { min-width: 30px; max-width: 30px; } /* Ambar No */
            th:nth-child(4), td:nth-child(4) { min-width: 45px; max-width: 45px; } /* Ambar Adƒ± */
            th:nth-child(5), td:nth-child(5) { min-width: 40px; max-width: 40px; } /* Fiyat Kaynaƒüƒ± */
            th:nth-child(6), td:nth-child(6) { min-width: 40px; max-width: 40px; } /* Aktif Satƒ±≈ü Fiyatƒ± */
            th:nth-child(7), td:nth-child(7) { min-width: 30px; max-width: 30px; } /* Stok Miktarƒ± */
            th:nth-child(8), td:nth-child(8) { min-width: 30px; max-width: 30px; } /* Devir Miktarƒ± */
            th:nth-child(9), td:nth-child(9) { min-width: 40px; max-width: 40px; } /* Ambar Giri≈ü Miktarƒ± */
            th:nth-child(10), td:nth-child(10) { min-width: 40px; max-width: 40px; } /* Son Alƒ±≈ü Tarihi */
            th:nth-child(11), td:nth-child(11) { min-width: 40px; max-width: 40px; } /* Son Alƒ±≈ü Fiyatƒ± */
            th:nth-child(12), td:nth-child(12) { min-width: 30px; max-width: 30px; } /* Son Alƒ±≈ü Miktarƒ± */
            th:nth-child(13), td:nth-child(13) { min-width: 40px; max-width: 40px; } /* Son Satƒ±≈ü Tarihi */
            th:nth-child(14), td:nth-child(14) { min-width: 40px; max-width: 40px; } /* Son Satƒ±≈ü Fiyatƒ± */
            th:nth-child(15), td:nth-child(15) { min-width: 30px; max-width: 30px; } /* Son Satƒ±≈ü Miktarƒ± */
            th:nth-child(16), td:nth-child(16) { min-width: 40px; max-width: 40px; } /* Son Alƒ±≈ü Tarihi */
            th:nth-child(17), td:nth-child(17) { min-width: 40px; max-width: 40px; } /* Son Alƒ±≈ü Fiyatƒ± */
            th:nth-child(18), td:nth-child(18) { min-width: 40px; max-width: 40px; } /* Son Satƒ±≈ü Tarihi */
            th:nth-child(19), td:nth-child(19) { min-width: 40px; max-width: 40px; } /* Son Satƒ±≈ü Fiyatƒ± */
            th:nth-child(20), td:nth-child(20) { min-width: 40px; max-width: 40px; } /* Son Alƒ±≈ü Toplamƒ± */
            th:nth-child(21), td:nth-child(21) { min-width: 40px; max-width: 40px; } /* Son Satƒ±≈ü Toplamƒ± */
            
            @media print {
              body { margin: 0; font-size: 12px; }
              .stats-grid { grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 18px; }
              .malzeme-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
              .stat-box, .malzeme-info { padding: 10px; }
              table { font-size: 11px; }
              th, td { padding: 3px; }
              .header { margin-bottom: 25px; padding: 18px; }
              .header-top { gap: 18px; margin-bottom: 12px; }
              .logo { width: 90px; }
              .header h1 { font-size: 22px; margin: 0 0 4px 0; }
              .header p { font-size: 14px; margin: 2px 0; }
              .stat-title { font-size: 11px; }
              .stat-value { font-size: 16px; }
              .stat-subtitle { font-size: 9px; }
              .malzeme-value { font-size: 18px; }
              .malzeme-label { font-size: 11px; }
              .section-title { font-size: 16px; margin: 18px 0 10px 0; }
              
              /* Print i√ßin kolon geni≈ülikleri - daha kompakt */
              th:nth-child(1), td:nth-child(1) { min-width: 25px; max-width: 25px; } /* ≈ûube No */
              th:nth-child(2), td:nth-child(2) { min-width: 40px; max-width: 40px; } /* ≈ûube Adƒ± */
              th:nth-child(3), td:nth-child(3) { min-width: 25px; max-width: 25px; } /* Ambar No */
              th:nth-child(4), td:nth-child(4) { min-width: 40px; max-width: 40px; } /* Ambar Adƒ± */
              th:nth-child(5), td:nth-child(5) { min-width: 35px; max-width: 35px; } /* Fiyat Kaynaƒüƒ± */
              th:nth-child(6), td:nth-child(6) { min-width: 35px; max-width: 35px; } /* Aktif Satƒ±≈ü Fiyatƒ± */
              th:nth-child(7), td:nth-child(7) { min-width: 25px; max-width: 25px; } /* Stok Miktarƒ± */
              th:nth-child(8), td:nth-child(8) { min-width: 25px; max-width: 25px; } /* Devir Miktarƒ± */
              th:nth-child(9), td:nth-child(9) { min-width: 35px; max-width: 35px; } /* Ambar Giri≈ü Miktarƒ± */
              th:nth-child(10), td:nth-child(10) { min-width: 35px; max-width: 35px; } /* Son Alƒ±≈ü Tarihi */
              th:nth-child(11), td:nth-child(11) { min-width: 35px; max-width: 35px; } /* Son Alƒ±≈ü Fiyatƒ± */
              th:nth-child(12), td:nth-child(12) { min-width: 25px; max-width: 25px; } /* Son Alƒ±≈ü Miktarƒ± */
              th:nth-child(13), td:nth-child(13) { min-width: 35px; max-width: 35px; } /* Son Satƒ±≈ü Tarihi */
              th:nth-child(14), td:nth-child(14) { min-width: 35px; max-width: 35px; } /* Son Satƒ±≈ü Fiyatƒ± */
              th:nth-child(15), td:nth-child(15) { min-width: 25px; max-width: 25px; } /* Son Satƒ±≈ü Miktarƒ± */
              th:nth-child(16), td:nth-child(16) { min-width: 35px; max-width: 35px; } /* Son Alƒ±≈ü Tarihi */
              th:nth-child(17), td:nth-child(17) { min-width: 35px; max-width: 35px; } /* Son Alƒ±≈ü Fiyatƒ± */
              th:nth-child(18), td:nth-child(18) { min-width: 35px; max-width: 35px; } /* Son Satƒ±≈ü Tarihi */
              th:nth-child(19), td:nth-child(19) { min-width: 35px; max-width: 35px; } /* Son Satƒ±≈ü Fiyatƒ± */
              th:nth-child(20), td:nth-child(20) { min-width: 35px; max-width: 35px; } /* Son Alƒ±≈ü Toplamƒ± */
              th:nth-child(21), td:nth-child(21) { min-width: 35px; max-width: 35px; } /* Son Satƒ±≈ü Toplamƒ± */
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="header-top">
              <img src="/img/btRapor.png" alt="btRapor Logo" class="logo" />
              <div class="header-content">
                <h1>MALZEME DETAY RAPORU</h1>
                <p><strong>Rapor Tarihi:</strong> ${new Date().toLocaleDateString('tr-TR')} - ${new Date().toLocaleTimeString('tr-TR')}</p>
                <p><strong>Malzeme Kodu:</strong> ${malzemeKodu}</p>
                <p><strong>Malzeme Adƒ±:</strong> ${malzemeAdi}</p>
                <p><strong>Tarih Aralƒ±ƒüƒ±:</strong> ${startDate} - ${endDate}</p>
              </div>
            </div>
          </div>

          <!-- ƒ∞statistikler -->
          <div class="stats-grid">
            <div class="stat-box primary">
              <div class="stat-title">TOPLAM ≈ûUBE</div>
              <div class="stat-value">${new Set(data.map(item => item['ƒ∞≈üyeri No'])).size}</div>
              <div class="stat-subtitle">Farklƒ± ≈üube sayƒ±sƒ±</div>
            </div>
            <div class="stat-box success">
              <div class="stat-title">TOPLAM AMBAR</div>
              <div class="stat-value">${new Set(data.map(item => item['Ambar No'])).size}</div>
              <div class="stat-subtitle">Farklƒ± ambar sayƒ±sƒ±</div>
            </div>
            <div class="stat-box warning">
              <div class="stat-title">TOPLAM STOK</div>
              <div class="stat-value">${formatNumber(data.reduce((sum, item) => sum + (item['Stok Miktarƒ±'] || 0), 0))}</div>
              <div class="stat-subtitle">Miktar toplamƒ±</div>
            </div>
            <div class="stat-box info">
              <div class="stat-title">ORTALAMA Fƒ∞YAT</div>
              <div class="stat-value">${formatCurrency(data.reduce((sum, item) => sum + (item['Aktif Satƒ±≈ü Fiyatƒ±'] || 0), 0) / Math.max(data.length, 1))}</div>
              <div class="stat-subtitle">Birim fiyat ortalamasƒ±</div>
            </div>
          </div>

          <!-- Malzeme Bilgileri -->
          <div class="malzeme-info">
            <h3>Malzeme √ñzet Bilgileri</h3>
            <div class="malzeme-grid">
              <div class="malzeme-item">
                <div class="malzeme-value">${malzemeKodu}</div>
                <div class="malzeme-label">Malzeme Kodu</div>
              </div>
              <div class="malzeme-item">
                <div class="malzeme-value">${malzemeAdi}</div>
                <div class="malzeme-label">Malzeme Adƒ±</div>
              </div>
              <div class="malzeme-item">
                <div class="malzeme-value">${data.length}</div>
                <div class="malzeme-label">Toplam Kayƒ±t</div>
              </div>
              <div class="malzeme-item">
                <div class="malzeme-value">${startDate} - ${endDate}</div>
                <div class="malzeme-label">Tarih Aralƒ±ƒüƒ±</div>
              </div>
            </div>
          </div>

          <!-- Detay Tablosu -->
          <div class="section-title">≈ûube ve Ambar Detaylarƒ±</div>
          <table>
            <thead>
              <tr>
                <th rowspan="2">≈ûube No</th>
                <th rowspan="2">≈ûube Adƒ±</th>
                <th rowspan="2">Ambar No</th>
                <th rowspan="2">Ambar Adƒ±</th>
                <th rowspan="2">Fiyat Kaynaƒüƒ±</th>
                <th colspan="11" class="center">Genel Bilgiler</th>
                <th colspan="6" class="center">D√∂nem ƒ∞√ßi Veriler</th>
              </tr>
              <tr>
                <th>Aktif Satƒ±≈ü Fiyatƒ±</th>
                <th>Son Fiyat Deƒüi≈üim Tarihi</th>
                <th>Stok Miktarƒ±</th>
                <th>Devir Miktarƒ±</th>
                <th>Ambar Giri≈ü Miktarƒ±</th>
                <th>Son Alƒ±≈ü Tarihi</th>
                <th>Son Alƒ±≈ü Fiyatƒ±</th>
                <th>Son Alƒ±≈ü Miktarƒ±</th>
                <th>Son Satƒ±≈ü Tarihi</th>
                <th>Son Satƒ±≈ü Fiyatƒ±</th>
                <th>D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi</th>
                <th>D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±</th>
                <th>D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±</th>
                <th>Son Satƒ±≈ü Tarihi (Aralƒ±k)</th>
                <th>D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±</th>
                <th>D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±</th>
              </tr>
            </thead>
            <tbody>
              ${data.map((item, index) => `
                <tr>
                  <td>${item['ƒ∞≈üyeri No'] || '-'}</td>
                  <td>${item['ƒ∞≈üyeri Adƒ±'] || '-'}</td>
                  <td>${item['Ambar No'] || '-'}</td>
                  <td>${item['Ambar Adƒ±'] || '-'}</td>
                  <td>${item['Fiyat Kaynaƒüƒ±'] || '-'}</td>
                  <td class="currency">${item['Aktif Satƒ±≈ü Fiyatƒ±'] ? formatCurrency(item['Aktif Satƒ±≈ü Fiyatƒ±']) : '-'}</td>
                  <td>${item['Son Fiyat Deƒüi≈üim Tarihi'] ? formatDate(item['Son Fiyat Deƒüi≈üim Tarihi']) : '-'}</td>
                  <td class="number">${item['Stok Miktarƒ±'] ? formatNumber(item['Stok Miktarƒ±']) : '-'}</td>
                  <td class="number">${item['Devir Miktarƒ±'] ? formatNumber(item['Devir Miktarƒ±']) : '-'}</td>
                  <td class="number">${item['Ambar Transfer Giri≈ü Miktarƒ±'] ? formatNumber(item['Ambar Transfer Giri≈ü Miktarƒ±']) : '-'}</td>
                  <td>${item['Son Alƒ±≈ü Tarihi'] ? formatDate(item['Son Alƒ±≈ü Tarihi']) : '-'}</td>
                  <td class="currency">${item['Son Alƒ±≈ü Birim Fiyatƒ±'] ? formatCurrency(item['Son Alƒ±≈ü Birim Fiyatƒ±']) : '-'}</td>
                  <td class="number">${item['Son Alƒ±≈ü Miktarƒ±'] ? formatNumber(item['Son Alƒ±≈ü Miktarƒ±']) : '-'}</td>
                  <td>${item['Son Satƒ±≈ü Tarihi'] ? formatDate(item['Son Satƒ±≈ü Tarihi']) : '-'}</td>
                  <td class="currency">${item['Son Satƒ±≈ü Birim Fiyatƒ±'] ? formatCurrency(item['Son Satƒ±≈ü Birim Fiyatƒ±']) : '-'}</td>
                  <td>${item['D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi'] ? formatDate(item['D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi']) : '-'}</td>
                  <td class="currency">${item['D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±'] ? formatCurrency(item['D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±']) : '-'}</td>
                  <td class="number">${item['D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±'] ? formatNumber(item['D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±']) : '-'}</td>
                  <td>${item['Son Satƒ±≈ü Tarihi (Tarih Aralƒ±ƒüƒ±)'] ? formatDate(item['Son Satƒ±≈ü Tarihi (Tarih Aralƒ±ƒüƒ±)']) : '-'}</td>
                  <td class="currency">${item['D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±'] ? formatCurrency(item['D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±']) : '-'}</td>
                  <td class="number">${item['D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±'] ? formatNumber(item['D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±']) : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
      </html>
    `;

    // Direkt yazdƒ±rma penceresi a√ß
    const printWindow = window.open('', '_blank');
    if (!printWindow) return;

    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // Sayfa y√ºklendikten sonra otomatik yazdƒ±rma penceresi a√ß
    printWindow.onload = () => {
      printWindow.print();
    };
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 overflow-y-auto">
      {/* Backdrop */}
      <div 
        className="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
        onClick={onClose}
      ></div>
      
      {/* Modal */}
      <div className="flex min-h-full items-start sm:items-center justify-center p-0 sm:p-4">
        <div className="relative w-full h-full sm:h-auto sm:max-w-[98vw] lg:max-w-[95vw] xl:max-w-[92vw] sm:max-h-[95vh] bg-white sm:rounded-lg shadow-xl sm:my-4 flex flex-col">
          {/* Modal Header */}
          <div className="flex-shrink-0 bg-gradient-to-r from-red-800 to-red-900 text-white p-4 sm:p-6 sm:rounded-t-lg">
            <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
              <div className="flex-1 min-w-0">
                <h3 className="text-lg sm:text-xl font-bold">üìä Malzeme Detaylarƒ±</h3>
                <p className="text-red-100 text-xs sm:text-sm mt-2 break-words">
                  Malzeme Kodu: {malzemeKodu} ‚Ä¢ Malzeme Adƒ±: {malzemeAdi}
                  {data.length > 0 && ` ‚Ä¢ ${data.length} ≈üube/ambar bulundu`}
                </p>
              </div>
              <div className="flex flex-wrap items-center gap-2 sm:gap-3 lg:gap-4">
                {/* Yeniden Y√ºkle Butonu */}
                <button
                  onClick={clearCacheAndReload}
                  disabled={loading}
                  className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-blue-800 bg-blue-100 border border-blue-300 rounded-lg hover:bg-blue-200 hover:border-blue-400 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                  title="Cache'i temizle ve yeni veri getir"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  {loading ? 'Y√ºkleniyor...' : 'Yeniden Y√ºkle'}
                </button>
                
                {/* Export Butonlarƒ± */}
                {data.length > 0 && (
                  <>
                    <button
                      onClick={() => exportToExcel()}
                      className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-green-800 bg-green-100 border border-green-300 rounded-lg hover:bg-green-200 hover:border-green-400 transition-all duration-200"
                      title="Excel olarak dƒ±≈üa aktar"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      Excel
                    </button>
                    <button
                      onClick={() => exportToPDF()}
                      className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-red-800 bg-red-100 border border-red-300 rounded-lg hover:bg-red-200 hover:border-red-400 transition-all duration-200"
                      title="PDF olarak dƒ±≈üa aktar"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                      PDF
                    </button>
                  </>
                )}
                <button
                  onClick={onClose}
                  className="text-white hover:text-red-200 transition-colors p-2 lg:p-3 rounded-lg hover:bg-red-700"
                  title="Detaylarƒ± kapat"
                >
                  <svg className="w-6 h-6 sm:w-7 sm:h-7 lg:w-7 lg:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

                           {/* Modal Body */}
          <div className="flex-1 p-3 sm:p-6 overflow-y-auto min-h-0">
           {loading ? (
             <div className="flex flex-col items-center justify-center py-12">
               {animationData && (
                 <div className="w-24 h-24 mb-4">
                   <Lottie animationData={animationData} loop={true} />
                 </div>
               )}
               <p className="text-gray-600 font-medium">
                 {spCreated ? 'Malzeme detaylarƒ± y√ºkleniyor...' : 'Stored procedure olu≈üturuluyor...'}
               </p>
             </div>
           ) : error ? (
             <div className="bg-red-50 border border-red-200 rounded-lg p-4">
               <div className="flex items-center gap-2 text-red-800">
                 <span>‚ùå</span>
                 <span className="font-medium">{error}</span>
               </div>
             </div>
                       ) : !spCreated ? (
              <div className="text-center py-12">
                <div className="text-gray-400 text-6xl mb-4">üîß</div>
                                 <p className="text-gray-600 mb-6">Malzeme detaylarƒ± i√ßin stored procedure olu≈üturuluyor...</p>
              </div>
           ) : data.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-gray-400 text-6xl mb-4">üì≠</div>
              <p className="text-gray-600">Bu malzeme i√ßin detay bulunamadƒ±</p>
            </div>
                      ) : (
              <div className="space-y-6">
                                 {/* ≈ûube Detaylarƒ± Tablosu */}
                 <div className="space-y-4">
                   <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                     <span className="text-red-600">üè¢</span>
                     ≈ûube Detaylarƒ±
                   </h3>
                   
                   <div className="bg-white rounded-lg shadow-sm border border-gray-200">
                       <div className="bg-gray-50 p-4 border-b border-gray-200">
                         <div className="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
                           <div className="flex items-center gap-3">
                             <div className="w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center">
                               <span className="text-gray-600 text-sm">üìä</span>
                             </div>
                             <div>
                               <h4 className="text-lg font-semibold text-gray-800">Malzeme Detay Listesi</h4>
                               <p className="text-gray-500 text-sm mt-1">
                                 {data.length} kayƒ±t bulundu
                               </p>
                             </div>
                           </div>
                           <div className="text-sm text-gray-500">
                             ≈ûube ve ambar bazƒ±nda detaylƒ± analiz
                           </div>
                         </div>
                       </div>
                       
                       <div className="overflow-x-auto overflow-y-auto max-h-[40vh] relative">
                         <table className="min-w-full divide-y divide-gray-200 table-fixed w-max">
                           <thead className="sticky top-0 z-20">
                             {/* Ana Grup Ba≈ülƒ±klarƒ± */}
                             <tr className="bg-gray-100 border-b border-gray-300">
                               <th rowSpan={2} className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-r border-gray-300 sticky left-0 z-30 bg-gray-100">
                                 <div>
                                   <div>≈ûube No</div>
                                   <div className="text-xs font-normal text-gray-500">Kod</div>
                                 </div>
                               </th>
                               <th rowSpan={2} className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-r border-gray-300 sticky left-[100px] z-30 bg-gray-100">
                                 <div>
                                   <div>≈ûube Adƒ±</div>
                                   <div className="text-xs font-normal text-gray-500">A√ßƒ±klama</div>
                                 </div>
                               </th>
                               <th rowSpan={2} className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-r border-gray-300">
                                 <div>
                                   <div>Ambar No</div>
                                   <div className="text-xs font-normal text-gray-500">Kod</div>
                                 </div>
                               </th>
                               <th rowSpan={2} className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-r border-gray-300 sticky top-0 z-20 bg-gray-100">
                                 <div>
                                   <div>Ambar Adƒ±</div>
                                   <div className="text-xs font-normal text-gray-500">A√ßƒ±klama</div>
                                 </div>
                               </th>
                               <th rowSpan={2} className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-r border-gray-300 sticky top-0 z-20 bg-gray-100">
                                 <div>
                                   <div>Fiyat Kaynaƒüƒ±</div>
                                   <div className="text-xs font-normal text-gray-500">Bilgi</div>
                                 </div>
                               </th>
                               <th colSpan={10} className="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border-r border-gray-300 bg-blue-50 sticky top-0 z-20">
                                 <div>
                                   <div>Genel Bilgiler</div>
                                   <div className="text-xs font-normal text-blue-600">Stok, fiyat ve hareket bilgileri</div>
                                 </div>
                               </th>
                               <th colSpan={6} className="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider bg-orange-50 sticky top-0 z-20">
                                 <div>
                                   <div>D√∂nem ƒ∞√ßi Veriler</div>
                                   <div className="text-xs font-normal text-orange-600">Belirtilen tarih aralƒ±ƒüƒ±ndaki veriler</div>
                                 </div>
                               </th>
                             </tr>
                             {/* Alt Ba≈ülƒ±klar - Genel Bilgiler */}
                             <tr className="bg-blue-100 border-b border-blue-200">
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Aktif Satƒ±≈ü Fiyatƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Son Fiyat Deƒüi≈üim Tarihi
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Stok Miktarƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Devir Miktarƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Ambar Giri≈ü Miktarƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Son Alƒ±≈ü Tarihi
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Son Alƒ±≈ü Fiyatƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Son Alƒ±≈ü Miktarƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 sticky top-12 z-15 bg-blue-100">
                                 Son Satƒ±≈ü Tarihi
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 border-r border-blue-200 sticky top-12 z-15 bg-blue-100">
                                 Son Satƒ±≈ü Fiyatƒ±
                               </th>
                               {/* Alt Ba≈ülƒ±klar - D√∂nem ƒ∞√ßi Veriler */}
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 bg-orange-100">
                                 D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 bg-orange-100">
                                 D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 bg-orange-100">
                                 D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 bg-orange-100">
                                 Son Satƒ±≈ü Tarihi (Tarih Aralƒ±ƒüƒ±)
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 bg-orange-100">
                                 D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±
                               </th>
                               <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 bg-orange-100">
                                 D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±
                               </th>
                             </tr>
                           </thead>
                           <tbody className="bg-white divide-y divide-gray-200">
                             {data.map((item, index) => (
                               <tr key={index} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors duration-150`}>
                                 <td className={`px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 min-w-[100px] border-r border-gray-200 sticky left-0 z-10 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100`}>
                                   {item['ƒ∞≈üyeri No']}
                                 </td>
                                 <td className={`px-4 py-3 whitespace-nowrap text-sm text-gray-900 min-w-[200px] border-r border-gray-200 sticky left-[100px] z-10 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100`}>
                                   {item['ƒ∞≈üyeri Adƒ±']}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 min-w-[100px] border-r border-gray-200">
                                   {item['Ambar No']}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-900 min-w-[150px] border-r border-gray-200">
                                   {item['Ambar Adƒ±']}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600 min-w-[120px] border-r border-gray-200">
                                   <span className="font-medium">{item['Fiyat Kaynaƒüƒ±']}</span>
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-green-700 min-w-[150px] bg-blue-50">
                                   {formatCurrency(item['Aktif Satƒ±≈ü Fiyatƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 min-w-[180px] bg-blue-50">
                                   {formatDate(item['Son Fiyat Deƒüi≈üim Tarihi'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-blue-700 min-w-[120px] bg-blue-50">
                                   {formatNumber(item['Stok Miktarƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-purple-700 min-w-[120px] bg-blue-50">
                                   {formatNumber(item['Devir Miktarƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-indigo-700 min-w-[150px] bg-blue-50">
                                   {formatNumber(item['Ambar Transfer Giri≈ü Miktarƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 min-w-[130px] bg-blue-50">
                                   {formatDate(item['Son Alƒ±≈ü Tarihi'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-green-700 min-w-[130px] bg-blue-50">
                                   {formatCurrency(item['Son Alƒ±≈ü Birim Fiyatƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-blue-700 min-w-[120px] bg-blue-50">
                                   {formatNumber(item['Son Alƒ±≈ü Miktarƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 min-w-[130px] bg-blue-50">
                                   {formatDate(item['Son Satƒ±≈ü Tarihi'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-red-700 min-w-[130px] bg-blue-50">
                                   {formatCurrency(item['Son Satƒ±≈ü Birim Fiyatƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 min-w-[180px] bg-orange-50">
                                   {formatDate(item['D√∂nem ƒ∞√ßi Son Alƒ±m Tarihi'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-green-700 min-w-[180px] bg-orange-50">
                                   {formatCurrency(item['D√∂nem ƒ∞√ßi Son Alƒ±m Fiyatƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-blue-700 min-w-[180px] bg-orange-50">
                                   {formatNumber(item['D√∂nem ƒ∞√ßi Son Alƒ±m Miktarƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 min-w-[180px] bg-orange-50">
                                   {formatDate(item['Son Satƒ±≈ü Tarihi (Tarih Aralƒ±ƒüƒ±)'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-red-700 min-w-[180px] bg-orange-50">
                                   {formatCurrency(item['D√∂nem ƒ∞√ßi Son Satƒ±≈ü Fiyatƒ±'])}
                                 </td>
                                 <td className="px-4 py-3 whitespace-nowrap text-sm font-semibold text-red-700 min-w-[180px] bg-orange-50">
                                   {formatNumber(item['D√∂nem ƒ∞√ßi Satƒ±≈ü Toplamƒ±'])}
                                 </td>
                               </tr>
                             ))}
                           </tbody>
                         </table>
                       </div>
                     </div>
                   
                   {/* √ñzet Bilgiler - Tablo Altƒ±nda */}
                   <div className="mt-6">
                     <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                       <span className="text-green-600">üìä</span>
                       √ñzet Bilgiler
                     </h3>
                     <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                       <div className="bg-blue-50 rounded-lg p-4">
                         <div className="text-sm text-blue-600 font-medium">Toplam ƒ∞≈üyeri</div>
                         <div className="text-2xl font-bold text-blue-900">
                           {new Set(data.map(item => item['ƒ∞≈üyeri No'])).size}
                         </div>
                       </div>
                       <div className="bg-green-50 rounded-lg p-4">
                         <div className="text-sm text-green-600 font-medium">Toplam Ambar</div>
                         <div className="text-2xl font-bold text-green-900">
                           {new Set(data.map(item => item['Ambar No'])).size}
                         </div>
                       </div>
                       <div className="bg-purple-50 rounded-lg p-4">
                         <div className="text-sm text-purple-600 font-medium">Toplam Stok</div>
                         <div className="text-2xl font-bold text-purple-900">
                           {formatNumber(data.reduce((sum, item) => sum + (item['Stok Miktarƒ±'] || 0), 0))}
                         </div>
                       </div>
                       <div className="bg-orange-50 rounded-lg p-4">
                         <div className="text-sm text-orange-600 font-medium">Ortalama Fiyat</div>
                         <div className="text-2xl font-bold text-orange-900">
                           {formatCurrency(data.reduce((sum, item) => sum + (item['Aktif Satƒ±≈ü Fiyatƒ±'] || 0), 0) / Math.max(data.length, 1))}
                         </div>
                       </div>
                     </div>
                   </div>
                 </div>
                             </div>
           )}
          </div>

          {/* Modal Footer */}
          <div className="flex-shrink-0 bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 sm:rounded-b-lg border-t border-gray-200">
            <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
              <div className="text-xs sm:text-sm text-gray-600">
                {data.length > 0 && (
                  <span>Toplam {data.length} ≈üube/ambar<span className="hidden sm:inline"> ‚Ä¢ ƒ∞≈üyeri ve ambar bazƒ±nda detaylƒ± bilgi</span></span>
                )}
              </div>
              <div className="flex items-center gap-2 sm:gap-3 lg:gap-4 justify-end">
                <button
                  onClick={onClose}
                  className="px-4 py-2 sm:px-6 sm:py-2 lg:px-8 lg:py-3 bg-red-800 text-white rounded-lg hover:bg-red-900 transition-colors font-medium text-sm lg:text-base"
                >
                  Kapat
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
